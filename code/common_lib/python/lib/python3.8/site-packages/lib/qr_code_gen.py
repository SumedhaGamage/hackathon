import io
import os

import qrcode
import boto3


class QRGenClient:
    def __init__(self):
        self.bucket_name = os.environ.get('QR_IMAGES_S3_BUCKET')
        self.s3 = boto3.resource('s3')
        self.default_file_ext = 'png'
        self.default_qr_dir = 'dispensary_qr'

    def gen(self, _id, data):
        img, file_path = self._create_image_data(_id, data)
        obj = self.s3.Object(self.bucket_name, file_path)
        obj.put(Body=img)
        location = boto3.client('s3').get_bucket_location(Bucket=self.bucket_name)['LocationConstraint']
        return "https://%s.s3-%s.amazonaws.com/%s" % (self.bucket_name, location, file_path)

    def _create_image_data(self, _id, data):
        pil_image = qrcode.make(data)
        in_mem_file = io.BytesIO()
        pil_image.save(in_mem_file, format=str(self.default_file_ext).upper())
        img = in_mem_file.getvalue()
        return img, "%s/%s.%s" % (self.default_qr_dir, _id, self.default_file_ext)


